{
    "$schema": "http://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json",
    "contentVersion": "1.0.0.0",
    "parameters": {
		"PublicIP": {
		  "type": "string",
		  "metadata": {
			"description": "Public Ip address for source in NSG."
      		}
	  	},
"cloudInit": {
  "type": "string",
  "defaultValue": "#cloud-config\npackage_update: true\npackage_upgrade: true\npackages:\n  - apache2\n  - easy-rsa\n  - zip\n  - unzip\n  - wget\n  - curl\n\nwrite_files:\n  - path: /opt/ca-lab/scripts/init-pki.sh\n    permissions: \"0755\"\n    content: |\n      #!/usr/bin/env bash\n      set -euo pipefail\n\n      EASYRSA_BIN=\"$(command -v easyrsa || true)\"\n      if [[ -z \"$EASYRSA_BIN\" && -x /usr/share/easy-rsa/easyrsa ]]; then\n        EASYRSA_BIN=\"/usr/share/easy-rsa/easyrsa\"\n      fi\n      [[ -z \"$EASYRSA_BIN\" ]] && echo \"easyrsa not found\" && exit 127\n\n      BASE=\"/opt/ca-lab/pki\"\n      ROOT=\"$BASE/root\"\n      INT=\"$BASE/intermediate\"\n\n      ROOT_CN=\"${1:-Lab Root CA}\"\n      INT_CN=\"${2:-Lab Intermediate CA}\"\n      COUNTRY=\"${3:-CR}\"\n      PROVINCE=\"${4:-SanJose}\"\n      CITY=\"${5:-Lab}\"\n      ORG=\"${6:-LabCA}\"\n      OU=\"${7:-IT}\"\n      EMAIL=\"${8:-admin@example.local}\"\n\n      # Idempotent\n      if [[ -f \"$ROOT/pki/ca.crt\" && -f \"$INT/pki/ca.crt\" && -f \"$INT/pki/private/ca.key\" ]]; then\n        echo \"PKI already initialized.\"\n        exit 0\n      fi\n\n      mkdir -p \"$ROOT\" \"$INT\"\n\n      write_vars() {\n        local dir=\"$1\"\n        cat > \"$dir/vars\" <<VARS\nset_var EASYRSA_REQ_COUNTRY    \"$COUNTRY\"\nset_var EASYRSA_REQ_PROVINCE   \"$PROVINCE\"\nset_var EASYRSA_REQ_CITY       \"$CITY\"\nset_var EASYRSA_REQ_ORG        \"$ORG\"\nset_var EASYRSA_REQ_EMAIL      \"$EMAIL\"\nset_var EASYRSA_REQ_OU         \"$OU\"\nset_var EASYRSA_ALGO           \"ec\"\nset_var EASYRSA_DIGEST         \"sha512\"\nVARS\n      }\n\n      export EASYRSA_BATCH=1\n\n      # ROOT\n      cd \"$ROOT\"\n      write_vars \"$ROOT\"\n      \"$EASYRSA_BIN\" init-pki\n      EASYRSA_REQ_CN=\"$ROOT_CN\" \"$EASYRSA_BIN\" build-ca nopass\n\n      # INTERMEDIATE (canonical name: ca)\n      cd \"$INT\"\n      write_vars \"$INT\"\n      \"$EASYRSA_BIN\" init-pki\n      EASYRSA_REQ_CN=\"$INT_CN\" \"$EASYRSA_BIN\" gen-req ca nopass\n\n      # Root signs intermediate\n      cd \"$ROOT\"\n      \"$EASYRSA_BIN\" import-req \"$INT/pki/reqs/ca.req\" intermediate\n      \"$EASYRSA_BIN\" sign-req ca intermediate\n\n      cp \"$ROOT/pki/issued/intermediate.crt\" \"$INT/pki/ca.crt\"\n      cp \"$ROOT/pki/ca.crt\" \"$INT/pki/root-ca.crt\"\n      cat \"$INT/pki/ca.crt\" \"$INT/pki/root-ca.crt\" > \"$INT/pki/ca-chain.crt\"\n\n  - path: /opt/ca-lab/scripts/issue-cert.sh\n    permissions: \"0755\"\n    content: |\n      #!/usr/bin/env bash\n      set -euo pipefail\n\n      EASYRSA_BIN=\"$(command -v easyrsa || true)\"\n      if [[ -z \"$EASYRSA_BIN\" && -x /usr/share/easy-rsa/easyrsa ]]; then\n        EASYRSA_BIN=\"/usr/share/easy-rsa/easyrsa\"\n      fi\n      [[ -z \"$EASYRSA_BIN\" ]] && echo \"easyrsa not found\" && exit 127\n\n      INT_DIR=\"/opt/ca-lab/pki/intermediate\"\n      ISSUED_BASE=\"/opt/ca-lab/issued\"\n\n      NAME=\"${1:?name required}\"\n      TYPE=\"${2:-server}\"\n      DAYS=\"${3:-365}\"\n      SANS_RAW=\"${4:-}\"\n\n      if [[ ! \"$NAME\" =~ ^[A-Za-z0-9._-]{3,64}$ ]]; then\n        echo \"Invalid name\"\n        exit 2\n      fi\n      if [[ \"$TYPE\" != \"server\" && \"$TYPE\" != \"client\" ]]; then\n        echo \"Invalid type\"\n        exit 2\n      fi\n      if [[ ! \"$DAYS\" =~ ^[0-9]{1,4}$ ]] || (( DAYS < 1 || DAYS > 3650 )); then\n        echo \"Invalid days\"\n        exit 2\n      fi\n      if [[ ! -f \"$INT_DIR/pki/ca.crt\" || ! -f \"$INT_DIR/pki/private/ca.key\" ]]; then\n        echo \"Intermediate CA not initialized\"\n        exit 3\n      fi\n\n      mkdir -p \"$ISSUED_BASE\"\n      OUT_DIR=\"$ISSUED_BASE/$NAME\"\n      mkdir -p \"$OUT_DIR\"\n\n      cd \"$INT_DIR\"\n      export EASYRSA_BATCH=1\n      export EASYRSA_CERT_EXPIRE=\"$DAYS\"\n\n      EXTRA_EXTS=\"\"\n      if [[ -n \"$SANS_RAW\" ]]; then\n        SANS=\"$(echo \"$SANS_RAW\" | tr -d ' ')\"\n        EXTRA_EXTS=\"subjectAltName=$SANS\"\n      fi\n\n      \"$EASYRSA_BIN\" --vars=\"$INT_DIR/vars\" gen-req \"$NAME\" nopass\n      if [[ -n \"$EXTRA_EXTS\" ]]; then\n        EASYRSA_EXTRA_EXTS=\"$EXTRA_EXTS\" \"$EASYRSA_BIN\" --vars=\"$INT_DIR/vars\" sign-req \"$TYPE\" \"$NAME\"\n      else\n        \"$EASYRSA_BIN\" --vars=\"$INT_DIR/vars\" sign-req \"$TYPE\" \"$NAME\"\n      fi\n\n      cp \"$INT_DIR/pki/private/$NAME.key\" \"$OUT_DIR/$NAME.key\"\n      cp \"$INT_DIR/pki/issued/$NAME.crt\" \"$OUT_DIR/$NAME.crt\"\n      cp \"$INT_DIR/pki/ca-chain.crt\" \"$OUT_DIR/ca-chain.crt\"\n      cat \"$OUT_DIR/$NAME.crt\" \"$OUT_DIR/ca-chain.crt\" > \"$OUT_DIR/fullchain.pem\"\n\n      cd \"$ISSUED_BASE\"\n      zip -qr \"$ISSUED_BASE/$NAME.zip\" \"$NAME\"\n\n      echo \"OK\"\n\nruncmd:\n  - CA_USER=\"$(getent passwd 1000 | cut -d: -f1)\"; echo \"CA_USER=$CA_USER\" > /opt/ca-lab/ca-user.env\n  - mkdir -p /opt/ca-lab/{scripts,pki,issued,app}\n  - chown -R \"$CA_USER:$CA_USER\" /opt/ca-lab\n  - wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O /tmp/packages-microsoft-prod.deb\n  - dpkg -i /tmp/packages-microsoft-prod.deb\n  - apt update\n  - apt install -y dotnet-sdk-8.0\n  - sudo -u \"$CA_USER\" -H bash -lc \"dotnet new web -n ca-web -o /opt/ca-lab/app/ca-web --force\"\n  - sudo -u \"$CA_USER\" -H bash -lc \"dotnet publish /opt/ca-lab/app/ca-web/ca-web.csproj -c Release -o /opt/ca-lab/app/ca-web/publish\"\n  - a2enmod proxy proxy_http rewrite\n  - systemctl restart apache2\n",
  "metadata": {
    "description": "cloud-init YAML injected into customData"
  }
}
    },
    "variables": {
        

		"location": "[resourceGroup().location]",
		"adminUsername": "labcauser",
		"adminPassword": "Testing12345",
		"enableAcceleratedNetworking": false,
		"networkSecurityGroupName": "LabCA-NSG",
		"virtualMachineRG": "[resourceGroup().name]",
		"nsgId": "[resourceId(resourceGroup().name, 'Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName'))]",
		

		"vNetName": "LabCA-VNET",
		"vNetAddressPrefixes": ["10.10.0.0/24"],
		"vNetSubnetName": "default",
		"vNetSubnetAddressPrefix": "10.10.0.0/24",
		"vmName": "LabCAServer",
		"networkInterfaceName": "[concat(variables('vmName'), '-Nic')]",
		"pipName": "[concat(variables('vmName'), '-ip')]",
		
        "vnetId": "[resourceId(resourceGroup().name,'Microsoft.Network/virtualNetworks', variables('vNetName'))]",
        "subnetRef": "[concat(variables('vnetId'), '/subnets/', variables('vNetSubnetName'))]"
    },
    "resources": [
        {
            "name": "[variables('networkInterfaceName')]",
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2022-11-01",
            "location": "[variables('location')]",
            "dependsOn": [
                "[concat('Microsoft.Network/networkSecurityGroups/', variables('networkSecurityGroupName'))]",
                "[concat('Microsoft.Network/virtualNetworks/', variables('vNetName'))]",
                "[concat('Microsoft.Network/publicIpAddresses/', variables('pipName'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "subnet": {
                                "id": "[variables('subnetRef')]"
                            },
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIpAddress": {
                                "id": "[resourceId(resourceGroup().name, 'Microsoft.Network/publicIpAddresses', variables('pipName'))]"
                            }
                        }
                    }
                ],
                "enableAcceleratedNetworking": "[variables('enableAcceleratedNetworking')]",
                "networkSecurityGroup": {
                    "id": "[variables('nsgId')]"
                }
            }
        },
{
    "name": "[variables('networkSecurityGroupName')]",
    "type": "Microsoft.Network/networkSecurityGroups",
    "apiVersion": "2020-05-01",
    "location": "[variables('location')]",
    "properties": {
        "securityRules": [
            {
                "name": "default-allow-22",
                "properties": {
                    "priority": 100,
                    "access": "Allow",
                    "direction": "Inbound",
                    "destinationPortRange": "22",
                    "protocol": "Tcp",
                    "sourceAddressPrefix": "[parameters('PublicIP')]",
                    "sourcePortRange": "*",
                    "destinationAddressPrefix": "*"
                }
            },
            {
                "name": "default-allow-80",
                "properties": {
                    "priority": 110,
                    "access": "Allow",
                    "direction": "Inbound",
                    "destinationPortRange": "80",
                    "protocol": "Tcp",
                    "sourceAddressPrefix": "[parameters('PublicIP')]",
                    "sourcePortRange": "*",
                    "destinationAddressPrefix": "*"
                }
            }
        ]
    }
},
        {
            "name": "[variables('vNetName')]",
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2024-10-01",
            "location": "[variables('location')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": "[variables('vNetAddressPrefixes')]"
                },
                "subnets": [
						{
						"name": "[variables('vNetSubnetName')]",
						"properties": {
						  "addressPrefix": "[variables('vNetSubnetAddressPrefix')]"
						}
						}
				]
            }
        },
        {
            "name": "[variables('pipName')]",
            "type": "Microsoft.Network/publicIpAddresses",
            "apiVersion": "2023-06-01",
            "location": "[variables('location')]",
            "properties": {
                "publicIpAllocationMethod": "Static"
            },
            "sku": {
                "name": "Standard"
            },
            "zones": [
                "1"
            ]
        },
{
            "name": "[variables('vmName')]",
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2024-03-01",
            "location": "[variables('location')]",
            "dependsOn": [
                "[concat('Microsoft.Network/networkInterfaces/', variables('networkInterfaceName'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "Standard_D2alds_v6"
                },
                "storageProfile": {
                    "osDisk": {
                        "createOption": "FromImage",
                        "managedDisk": {
                            "storageAccountType": "Premium_LRS"
                        }
                    },
                    "imageReference": {
                "publisher": "canonical",
                "offer": "ubuntu-24_04-lts",
                "sku": "server",
                "version": "latest"
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName'))]"
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[variables('vmName')]",
                    "adminUsername": "[variables('adminUsername')]",
                    "adminPassword": "[variables('adminPassword')]",
					"customData": "[base64(parameters('cloudInit'))]",
                    "linuxConfiguration": {
                        "patchSettings": {
                            "patchMode": "ImageDefault"
                        }
                    }
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true
                    }
                }
            }
        }
    ],
    "outputs": {
        "adminUsername": {
            "type": "string",
            "value": "[variables('adminUsername')]"
        }
    }
}
