#cloud-config
package_update: true
package_upgrade: true

packages:
  - apache2
  - easy-rsa
  - zip
  - unzip
  - wget
  - curl

write_files:
  # ---------- init-pki.sh (CLEAN: intermediate CA is "ca") ----------
  - path: /opt/ca-lab/scripts/init-pki.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      EASYRSA_BIN="$(command -v easyrsa || true)"
      if [[ -z "${EASYRSA_BIN}" && -x /usr/share/easy-rsa/easyrsa ]]; then
        EASYRSA_BIN="/usr/share/easy-rsa/easyrsa"
      fi
      if [[ -z "${EASYRSA_BIN}" ]]; then
        echo "easyrsa not found"
        exit 127
      fi

      BASE="/opt/ca-lab/pki"
      ROOT_DIR="$BASE/root"
      INT_DIR="$BASE/intermediate"

      ROOT_CN="${1:-Lab Root CA}"
      INT_CN="${2:-Lab Intermediate CA}"
      COUNTRY="${3:-CR}"
      PROVINCE="${4:-SanJose}"
      CITY="${5:-Lab}"
      ORG="${6:-LabCA}"
      OU="${7:-IT}"
      EMAIL="${8:-admin@example.local}"

      # Idempotent: do nothing if already initialized
      if [[ -f "$ROOT_DIR/pki/ca.crt" && -f "$INT_DIR/pki/ca.crt" && -f "$INT_DIR/pki/private/ca.key" ]]; then
        echo "PKI already initialized."
        exit 0
      fi

      mkdir -p "$ROOT_DIR" "$INT_DIR"

      write_vars() {
        local dir="$1"
        cat > "$dir/vars" <<VARS
      set_var EASYRSA_REQ_COUNTRY    "$COUNTRY"
      set_var EASYRSA_REQ_PROVINCE   "$PROVINCE"
      set_var EASYRSA_REQ_CITY       "$CITY"
      set_var EASYRSA_REQ_ORG        "$ORG"
      set_var EASYRSA_REQ_EMAIL      "$EMAIL"
      set_var EASYRSA_REQ_OU         "$OU"
      set_var EASYRSA_ALGO           "ec"
      set_var EASYRSA_DIGEST         "sha512"
      VARS
      }

      export EASYRSA_BATCH=1

      # ---- ROOT CA ----
      cd "$ROOT_DIR"
      write_vars "$ROOT_DIR"
      "$EASYRSA_BIN" init-pki
      EASYRSA_REQ_CN="$ROOT_CN" "$EASYRSA_BIN" build-ca nopass

      # ---- INTERMEDIATE CA (IMPORTANT: name is "ca") ----
      cd "$INT_DIR"
      write_vars "$INT_DIR"
      "$EASYRSA_BIN" init-pki
      EASYRSA_REQ_CN="$INT_CN" "$EASYRSA_BIN" gen-req ca nopass

      # Root signs the intermediate CA request (file name is ca.req)
      cd "$ROOT_DIR"
      "$EASYRSA_BIN" import-req "$INT_DIR/pki/reqs/ca.req" intermediate-ca
      "$EASYRSA_BIN" sign-req ca intermediate-ca

      # Place intermediate CA cert in the intermediate PKI as ca.crt
      cp "$ROOT_DIR/pki/issued/intermediate-ca.crt" "$INT_DIR/pki/ca.crt"

      # Build chain (intermediate + root)
      cp "$ROOT_DIR/pki/ca.crt" "$INT_DIR/pki/root-ca.crt"
      cat "$INT_DIR/pki/ca.crt" "$INT_DIR/pki/root-ca.crt" > "$INT_DIR/pki/ca-chain.crt"

      echo "PKI initialized OK."
      echo "Root CA: $ROOT_DIR/pki/ca.crt"
      echo "Intermediate CA: $INT_DIR/pki/ca.crt"
      echo "Chain: $INT_DIR/pki/ca-chain.crt"

  # ---------- issue-cert.sh (uses intermediate CA canonical files) ----------
  - path: /opt/ca-lab/scripts/issue-cert.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      EASYRSA_BIN="$(command -v easyrsa || true)"
      if [[ -z "${EASYRSA_BIN}" && -x /usr/share/easy-rsa/easyrsa ]]; then
        EASYRSA_BIN="/usr/share/easy-rsa/easyrsa"
      fi
      if [[ -z "${EASYRSA_BIN}" ]]; then
        echo "easyrsa not found"
        exit 127
      fi

      INT_DIR="/opt/ca-lab/pki/intermediate"
      ISSUED_BASE="/opt/ca-lab/issued"

      NAME="${1:?name required}"
      TYPE="${2:-server}"          # server | client
      DAYS="${3:-365}"             # 1..3650
      SANS_RAW="${4:-}"            # DNS:a,IP:1.2.3.4

      # Validate name
      if [[ ! "$NAME" =~ ^[A-Za-z0-9._-]{3,64}$ ]]; then
        echo "Invalid name. Use 3-64 chars: A-Z a-z 0-9 . _ -"
        exit 2
      fi
      if [[ "$TYPE" != "server" && "$TYPE" != "client" ]]; then
        echo "Invalid type. Use server|client"
        exit 2
      fi
      if [[ ! "$DAYS" =~ ^[0-9]{1,4}$ ]] || (( DAYS < 1 || DAYS > 3650 )); then
        echo "Invalid days. Use 1..3650"
        exit 2
      fi

      # Ensure intermediate CA exists
      if [[ ! -f "$INT_DIR/pki/ca.crt" || ! -f "$INT_DIR/pki/private/ca.key" ]]; then
        echo "Intermediate CA not initialized. Run init-pki.sh first."
        exit 3
      fi

      mkdir -p "$ISSUED_BASE"
      OUT_DIR="$ISSUED_BASE/$NAME"
      mkdir -p "$OUT_DIR"

      cd "$INT_DIR"
      export EASYRSA_BATCH=1
      export EASYRSA_CERT_EXPIRE="$DAYS"

      EXTRA_EXTS=""
      if [[ -n "$SANS_RAW" ]]; then
        SANS="$(echo "$SANS_RAW" | tr -d ' ')"
        if [[ ! "$SANS" =~ ^(DNS:[A-Za-z0-9.-]+|IP:[0-9a-fA-F:.]+)(,(DNS:[A-Za-z0-9.-]+|IP:[0-9a-fA-F:.]+))*$ ]]; then
          echo "Invalid SANs. Example: DNS:web01.lab,IP:10.0.0.4"
          exit 2
        fi
        EXTRA_EXTS="subjectAltName=$SANS"
      fi

      "$EASYRSA_BIN" --vars="$INT_DIR/vars" gen-req "$NAME" nopass

      if [[ -n "$EXTRA_EXTS" ]]; then
        EASYRSA_EXTRA_EXTS="$EXTRA_EXTS" "$EASYRSA_BIN" --vars="$INT_DIR/vars" sign-req "$TYPE" "$NAME"
      else
        "$EASYRSA_BIN" --vars="$INT_DIR/vars" sign-req "$TYPE" "$NAME"
      fi

      cp "$INT_DIR/pki/private/$NAME.key" "$OUT_DIR/$NAME.key"
      cp "$INT_DIR/pki/issued/$NAME.crt" "$OUT_DIR/$NAME.crt"
      cp "$INT_DIR/pki/ca-chain.crt" "$OUT_DIR/ca-chain.crt"
      cat "$OUT_DIR/$NAME.crt" "$OUT_DIR/ca-chain.crt" > "$OUT_DIR/fullchain.pem"

      cd "$ISSUED_BASE"
      zip -qr "$ISSUED_BASE/$NAME.zip" "$NAME"

      echo "OK"
      echo "OUT_DIR=$OUT_DIR"
      echo "ZIP=$ISSUED_BASE/$NAME.zip"

  # ---------- Apache vhost ----------
  - path: /etc/apache2/sites-available/000-default.conf
    permissions: "0644"
    content: |
      <VirtualHost *:80>
        ServerName localhost

        ProxyPreserveHost On
        ProxyPass / http://127.0.0.1:5000/
        ProxyPassReverse / http://127.0.0.1:5000/
      </VirtualHost>

  # ---------- systemd unit (User is set at runtime with sed) ----------
  - path: /etc/systemd/system/ca-web.service
    permissions: "0644"
    content: |
      [Unit]
      Description=CA Lab Web App
      After=network.target

      [Service]
      WorkingDirectory=/opt/ca-lab/app/ca-web/publish
      ExecStart=/usr/bin/dotnet /opt/ca-lab/app/ca-web/publish/ca-web.dll
      Restart=always
      User=__CA_USER__
      Environment=ASPNETCORE_URLS=http://127.0.0.1:5000
      Environment=ASPNETCORE_ENVIRONMENT=Production

      [Install]
      WantedBy=multi-user.target

runcmd:
  # ---- Determine the first normal user (uid 1000) and use it for ownership/service ----
  - CA_USER="$(getent passwd 1000 | cut -d: -f1)"; echo "CA_USER=$CA_USER" | tee /opt/ca-lab/ca-user.env
  - mkdir -p /opt/ca-lab/{app,scripts,pki,issued}
  - chown -R "$(cat /opt/ca-lab/ca-user.env | cut -d= -f2):$(cat /opt/ca-lab/ca-user.env | cut -d= -f2)" /opt/ca-lab

  # ---- Install .NET 8 SDK ----
  - wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O /tmp/packages-microsoft-prod.deb
  - dpkg -i /tmp/packages-microsoft-prod.deb
  - apt update
  - apt install -y dotnet-sdk-8.0
  - rm /tmp/packages-microsoft-prod.deb

  # ---- Create ASP.NET Core app (Minimal API with /setup + /cert/new) ----
  - CA_USER="$(getent passwd 1000 | cut -d: -f1)"
  - sudo -u "$CA_USER" -H bash -lc "dotnet new web -n ca-web -o /opt/ca-lab/app/ca-web --force"

  - bash -lc "cat > /opt/ca-lab/app/ca-web/Program.cs <<'EOF'
      using System.Diagnostics;
      using System.Text;
      using System.Text.Encodings.Web;

      var builder = WebApplication.CreateBuilder(args);
      var app = builder.Build();

      string RootCrt = \"/opt/ca-lab/pki/root/pki/ca.crt\";
      string ChainCrt = \"/opt/ca-lab/pki/intermediate/pki/ca-chain.crt\";
      string InitScript = \"/opt/ca-lab/scripts/init-pki.sh\";
      string IssueScript = \"/opt/ca-lab/scripts/issue-cert.sh\";
      string IssuedBase = \"/opt/ca-lab/issued\";

      bool PkiReady() => File.Exists(RootCrt) && File.Exists(ChainCrt);

      static string H(string s) => HtmlEncoder.Default.Encode(s ?? \"\");
      static bool IsSafeName(string s) => s.Length is >= 3 and <= 64 && s.All(ch => char.IsLetterOrDigit(ch) || \"._-\".Contains(ch));
      static bool IsSafeText(string s) => s.Length is >= 1 and <= 64 && s.All(ch => char.IsLetterOrDigit(ch) || \" .-_\".Contains(ch));

      app.MapGet(\"/\", () =>
      {
          var sb = new StringBuilder();
          sb.AppendLine(\"<html><body style='font-family:Segoe UI,Arial'>\");
          sb.AppendLine(\"<h2>Lab CA Server</h2>\");
          sb.AppendLine($\"<p>Status: <b>{(PkiReady() ? \"PKI READY ✅\" : \"NOT INITIALIZED ❌\")}</b></p>\");

          if (!PkiReady())
          {
              sb.AppendLine(\"<p><a href='/setup'>Go to /setup</a></p>\");
          }
          else
          {
              sb.AppendLine(\"<ul>\");
              sb.AppendLine(\"<li><a href='/root.crt'>Download Root CA (root-ca.crt)</a></li>\");
              sb.AppendLine(\"<li><a href='/ca-chain.crt'>Download CA Chain (intermediate+root)</a></li>\");
              sb.AppendLine(\"<li><a href='/cert/new'>Issue a new certificate</a></li>\");
              sb.AppendLine(\"</ul>\");
          }

          sb.AppendLine(\"</body></html>\");
          return Results.Content(sb.ToString(), \"text/html\");
      });

      app.MapGet(\"/setup\", () =>
      {
          if (PkiReady())
              return Results.Content(\"<html><body><h3>PKI already initialized ✅</h3><a href='/'>Home</a></body></html>\", \"text/html\");

          var tokenEnabled = !string.IsNullOrWhiteSpace(Environment.GetEnvironmentVariable(\"SETUP_TOKEN\"));

          var html = $@\"
      <html><body style='font-family:Segoe UI,Arial; max-width:820px'>
      <h2>Initialize PKI (Root + Intermediate)</h2>
      <p><b>Lab mode:</b> created with <code>nopass</code> for automation.</p>

      <form method='post' action='/setup'>
        {(tokenEnabled ? \"<label>Setup Token</label><br><input name='token' type='password' style='width:420px' /><br><br>\" : \"\")}

        <label>Root CA CN</label><br><input name='rootCn' value='Lab Root CA' style='width:420px' /><br><br>
        <label>Intermediate CA CN</label><br><input name='intCn' value='Lab Intermediate CA' style='width:420px' /><br><br>

        <fieldset style='padding:12px'>
          <legend>Org info</legend>
          <label>Country</label><br><input name='country' value='CR' /><br>
          <label>Province/State</label><br><input name='province' value='SanJose' style='width:420px' /><br>
          <label>City</label><br><input name='city' value='Lab' style='width:420px' /><br>
          <label>Org</label><br><input name='org' value='LabCA' style='width:420px' /><br>
          <label>OU</label><br><input name='ou' value='IT' style='width:420px' /><br>
          <label>Email</label><br><input name='email' value='admin@example.local' style='width:420px' /><br>
        </fieldset><br>

        <button type='submit'>Create PKI</button>
      </form>
      <p><a href='/'>Home</a></p>
      </body></html>\";
          return Results.Content(html, \"text/html\");
      });

      app.MapPost(\"/setup\", async (HttpRequest req) =>
      {
          if (PkiReady())
              return Results.BadRequest(\"PKI already initialized.\");

          var form = await req.ReadFormAsync();

          var expectedToken = Environment.GetEnvironmentVariable(\"SETUP_TOKEN\");
          if (!string.IsNullOrWhiteSpace(expectedToken))
          {
              if (form[\"token\"].ToString() != expectedToken)
                  return Results.Unauthorized();
          }

          string rootCn = form[\"rootCn\"].ToString().Trim();
          string intCn  = form[\"intCn\"].ToString().Trim();
          if (!IsSafeText(rootCn) || !IsSafeText(intCn))
              return Results.BadRequest(\"Invalid CN.\");

          string country  = form[\"country\"].ToString().Trim();
          string province = form[\"province\"].ToString().Trim();
          string city     = form[\"city\"].ToString().Trim();
          string org      = form[\"org\"].ToString().Trim();
          string ou       = form[\"ou\"].ToString().Trim();
          string email    = form[\"email\"].ToString().Trim();

          var psi = new ProcessStartInfo
          {
              FileName = \"/bin/bash\",
              RedirectStandardOutput = true,
              RedirectStandardError = true
          };
          psi.ArgumentList.Add(InitScript);
          psi.ArgumentList.Add(rootCn); psi.ArgumentList.Add(intCn);
          psi.ArgumentList.Add(country); psi.ArgumentList.Add(province); psi.ArgumentList.Add(city);
          psi.ArgumentList.Add(org); psi.ArgumentList.Add(ou); psi.ArgumentList.Add(email);

          using var p = Process.Start(psi)!;
          var stdout = await p.StandardOutput.ReadToEndAsync();
          var stderr = await p.StandardError.ReadToEndAsync();
          await p.WaitForExitAsync();

          if (p.ExitCode != 0)
              return Results.Content($\"<html><body><h3>Setup failed ❌</h3><pre>{H(stdout)}\\n{H(stderr)}</pre><a href='/setup'>Back</a></body></html>\", \"text/html\");

          return Results.Redirect(\"/\");
      });

      app.MapGet(\"/root.crt\", () =>
      {
          if (!File.Exists(RootCrt)) return Results.NotFound(\"Root CA not found.\");
          return Results.File(RootCrt, \"application/x-x509-ca-cert\", \"root-ca.crt\");
      });

      app.MapGet(\"/ca-chain.crt\", () =>
      {
          if (!File.Exists(ChainCrt)) return Results.NotFound(\"CA chain not found.\");
          return Results.File(ChainCrt, \"application/x-x509-ca-cert\", \"ca-chain.crt\");
      });

      app.MapGet(\"/cert/new\", () =>
      {
          if (!PkiReady())
              return Results.Content(\"<html><body><h3>PKI not initialized ❌</h3><a href='/setup'>Go to /setup</a></body></html>\", \"text/html\");

          var html = @\"
      <html><body style='font-family:Segoe UI,Arial; max-width:820px'>
      <h2>Issue a certificate</h2>
      <form method='post' action='/cert/new'>
        <label>Name</label><br><input name='name' value='web01' style='width:420px' /><br><br>
        <label>Type</label><br>
        <select name='type'><option value='server' selected>server</option><option value='client'>client</option></select><br><br>
        <label>Validity (days)</label><br><input name='days' value='365' /><br><br>
        <label>SANs (comma-separated)</label><br><input name='sans' value='DNS:web01.lab,IP:10.0.0.4' style='width:620px' /><br>
        <small>Example: DNS:web01.lab,IP:10.0.0.4</small><br><br>
        <button type='submit'>Generate + Download ZIP</button>
      </form>
      <p><a href='/'>Home</a></p>
      </body></html>\";
          return Results.Content(html, \"text/html\");
      });

      app.MapPost(\"/cert/new\", async (HttpRequest req) =>
      {
          if (!PkiReady()) return Results.BadRequest(\"PKI not initialized.\");

          var form = await req.ReadFormAsync();
          string name = form[\"name\"].ToString().Trim();
          string type = form[\"type\"].ToString().Trim();
          string days = form[\"days\"].ToString().Trim();
          string sans = form[\"sans\"].ToString().Trim();

          if (!IsSafeName(name)) return Results.BadRequest(\"Invalid name.\");
          if (type != \"server\" && type != \"client\") return Results.BadRequest(\"Invalid type.\");
          if (!int.TryParse(days, out var d) || d < 1 || d > 3650) return Results.BadRequest(\"Invalid days.\");

          var psi = new ProcessStartInfo
          {
              FileName = \"/bin/bash\",
              RedirectStandardOutput = true,
              RedirectStandardError = true
          };
          psi.ArgumentList.Add(IssueScript);
          psi.ArgumentList.Add(name);
          psi.ArgumentList.Add(type);
          psi.ArgumentList.Add(d.ToString());
          psi.ArgumentList.Add(sans);

          using var p = Process.Start(psi)!;
          var stdout = await p.StandardOutput.ReadToEndAsync();
          var stderr = await p.StandardError.ReadToEndAsync();
          await p.WaitForExitAsync();

          if (p.ExitCode != 0)
              return Results.Content($\"<html><body><h3>Issue failed ❌</h3><pre>{H(stdout)}\\n{H(stderr)}</pre><a href='/cert/new'>Back</a></body></html>\", \"text/html\");

          return Results.Redirect($\"/cert/download/{Uri.EscapeDataString(name)}\");
      });

      app.MapGet(\"/cert/download/{name}\", (string name) =>
      {
          if (!IsSafeName(name)) return Results.BadRequest(\"Invalid name.\");
          var zipPath = Path.Combine(IssuedBase, $\"{name}.zip\");
          if (!File.Exists(zipPath)) return Results.NotFound(\"ZIP not found.\");
          return Results.File(zipPath, \"application/zip\", $\"{name}.zip\");
      });

      app.Run();
      EOF"

  - CA_USER="$(getent passwd 1000 | cut -d: -f1)"
  - sudo -u "$CA_USER" -H bash -lc "dotnet publish /opt/ca-lab/app/ca-web/ca-web.csproj -c Release -o /opt/ca-lab/app/ca-web/publish"

  # ---- Apache + systemd wiring ----
  - a2enmod proxy proxy_http rewrite
  - systemctl restart apache2
  - CA_USER="$(getent passwd 1000 | cut -d: -f1)"; sed -i "s/__CA_USER__/${CA_USER}/g" /etc/systemd/system/ca-web.service
  - systemctl daemon-reload
  - systemctl enable --now ca-web

  # ---- Permissions (keys private, certs readable) ----
  - CA_USER="$(getent passwd 1000 | cut -d: -f1)"
  - chown -R "$CA_USER:$CA_USER" /opt/ca-lab
  - chmod -R 700 /opt/ca-lab/pki /opt/ca-lab/issued
